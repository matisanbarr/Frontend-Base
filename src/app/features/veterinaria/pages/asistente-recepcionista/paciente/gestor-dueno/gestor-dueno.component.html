<app-alert-global></app-alert-global>
<!-- Botón volver -->
<div class="mb-3">
  <button class="btn btn-vet" (click)="volver(0)"><i class="bi bi-arrow-left"></i> Volver</button>
</div>

<!-- Contenedor principal -->
<div
  class="container py-4"
  style="
    background: #f6fff6;
    border-radius: 18px;
    box-shadow: 0 2px 12px #d0f5d0;
    position: relative;
  "
>
  <div class="vet-bg-icon">
    <i class="bi bi-paw" style="font-size: 5rem; color: #b2e2b2; opacity: 0.15"></i>
  </div>
  <!-- Título y botón nuevo dueño -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold d-flex align-items-center" style="color: #4caf50; letter-spacing: 1px">
      <i class="bi bi-paw me-2" style="font-size: 2rem; color: #81c784"></i>
      Gestor de Dueños de Mascotas
    </h2>
    <button class="btn btn-vet" (click)="abrirFormulario()">
      <i class="bi bi-person-plus"></i> Nuevo Dueño
    </button>
  </div>
  <!-- Buscador -->
  <div class="vet-search-flex mb-4">
    <input
      type="text"
      class="form-control vet-input"
      placeholder="Buscar dueño o mascota"
      [(ngModel)]="busqueda"
    />
    <button class="btn btn-vet vet-search-btn" (click)="buscar()">
      <i class="bi bi-search"></i> Buscar
    </button>
  </div>
  <!-- Spinner de carga -->
  <div *ngIf="cargandoLista" class="d-flex justify-content-center align-items-center my-4">
    <div class="spinner-border" style="color: #4caf50; width: 3rem; height: 3rem">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>
  <!-- Tabla de dueños -->
  <div class="vet-table-responsive" *ngIf="!cargandoLista">
    <table class="table table-hover vet-table">
      <thead style="background: #e8f5e9">
        <tr>
          <th style="color: #388e3c"><i class="bi bi-person"></i> Nombre</th>
          <th style="color: #388e3c"><i class="bi bi-telephone"></i> Teléfono</th>
          <th style="color: #388e3c"><i class="bi bi-envelope"></i> Email</th>
          <th style="color: #388e3c"><i class="bi bi-paw"></i> Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let dueno of duenos">
          <td>{{ dueno.nombre }}</td>
          <td>{{ dueno.telefono }}</td>
          <td>{{ dueno.email }}</td>
          <td>
            <button
              class="btn btn-sm btn-primary rounded-pill me-2"
              (click)="abrirModalMascotas(dueno)"
            >
              <i class="bi bi-emoji-smile"></i> Gestionar Mascotas
            </button>
            <button class="btn btn-sm btn-vet me-2" (click)="abrirFormulario(dueno)">
              <i class="bi bi-pencil"></i> Editar
            </button>
            <button class="btn btn-sm btn-vet-danger" (click)="confirmarEliminar(dueno)">
              <i class="bi bi-trash"></i> Eliminar
            </button>
          </td>
        </tr>
        <tr *ngIf="duenos.length === 0">
          <td colspan="4" class="text-center" style="color: #a3a3a3">
            No hay dueños ni mascotas registrados.
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <!-- Paginación -->
  <nav *ngIf="totalDuenos > pageSize">
    <ul class="pagination justify-content-center vet-pagination">
      <li class="page-item" [class.disabled]="paginaActual === 1">
        <button class="page-link vet-page-link" (click)="cambiarPagina(paginaActual - 1)">
          &laquo;
        </button>
      </li>
      <li class="page-item" *ngFor="let p of paginas" [class.active]="paginaActual === p">
        <button class="page-link vet-page-link" (click)="cambiarPagina(p)">{{ p }}</button>
      </li>
      <li class="page-item" [class.disabled]="paginaActual === paginas.length">
        <button class="page-link vet-page-link" (click)="cambiarPagina(paginaActual + 1)">
          &raquo;
        </button>
      </li>
    </ul>
  </nav>

  <!-- Modal Formulario Crear/Editar -->
  <div *ngIf="mostrarFormulario">
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content vet-modal">
          <div class="modal-header" style="background: #e8f5e9">
            <h5 class="modal-title d-flex align-items-center">
              <i class="bi bi-paw me-2" style="color: #81c784"></i>
              {{ editando ? 'Editar Dueño' : 'Nuevo Dueño' }}
            </h5>
            <button type="button" class="btn-close" (click)="cerrarFormulario()"></button>
          </div>
          <div class="modal-body">
            <form [formGroup]="duenoForm" (ngSubmit)="guardarDueno()">
              <div class="mb-3">
                <label class="form-label"><i class="bi bi-person me-1"></i> Nombre</label>
                <input
                  type="text"
                  class="form-control vet-input"
                  formControlName="nombre"
                  (blur)="duenoForm.get('nombre')?.markAsTouched()"
                />
                <div
                  *ngIf="duenoForm.get('nombre')?.invalid && duenoForm.get('nombre')?.touched"
                  class="text-danger small"
                >
                  <span *ngIf="duenoForm.get('nombre')?.errors?.['required']"
                    >El nombre es obligatorio.</span
                  >
                  <span *ngIf="duenoForm.get('nombre')?.errors?.['minlength']"
                    >Mínimo 3 caracteres.</span
                  >
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label"><i class="bi bi-telephone me-1"></i> Teléfono</label>
                <input
                  type="text"
                  class="form-control vet-input"
                  formControlName="telefono"
                  (blur)="duenoForm.get('telefono')?.markAsTouched()"
                />
                <div
                  *ngIf="duenoForm.get('telefono')?.invalid && duenoForm.get('telefono')?.touched"
                  class="text-danger small"
                >
                  <span *ngIf="duenoForm.get('telefono')?.errors?.['required']"
                    >El teléfono es obligatorio.</span
                  >
                  <span *ngIf="duenoForm.get('telefono')?.errors?.['pattern']"
                    >Debe ser numérico y mínimo 8 dígitos.</span
                  >
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label"><i class="bi bi-house me-1"></i> Dirección</label>
                <input
                  type="text"
                  class="form-control vet-input"
                  formControlName="direccion"
                  (blur)="duenoForm.get('direccion')?.markAsTouched()"
                />
                <div
                  *ngIf="duenoForm.get('direccion')?.invalid && duenoForm.get('direccion')?.touched"
                  class="text-danger small"
                >
                  <span *ngIf="duenoForm.get('direccion')?.errors?.['required']"
                    >La dirección es obligatoria.</span
                  >
                  <span *ngIf="duenoForm.get('direccion')?.errors?.['minlength']"
                    >Mínimo 5 caracteres.</span
                  >
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label"><i class="bi bi-envelope me-1"></i> Email</label>
                <input
                  type="email"
                  class="form-control vet-input"
                  formControlName="email"
                  (blur)="duenoForm.get('email')?.markAsTouched()"
                />
                <div
                  *ngIf="duenoForm.get('email')?.invalid && duenoForm.get('email')?.touched"
                  class="text-danger small"
                >
                  <span *ngIf="duenoForm.get('email')?.errors?.['email']"
                    >Formato de email inválido.</span
                  >
                </div>
              </div>
              <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-vet me-2" (click)="cerrarFormulario()">
                  <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="submit" class="btn btn-vet" [disabled]="duenoForm.invalid">
                  <i class="bi bi-check-circle"></i>
                  {{ editando ? 'Modificar Dueño' : 'Crear Dueño' }}
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Confirmación Eliminar -->
  <div *ngIf="duenoAEliminar">
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content vet-modal">
          <div class="modal-header" style="background: #f7a3a3">
            <h5 class="modal-title d-flex align-items-center">
              <i class="bi bi-exclamation-triangle me-2" style="color: #ff6363"></i>
              Confirmar Eliminación
            </h5>
            <button type="button" class="btn-close" (click)="cancelarEliminar()"></button>
          </div>
          <div class="modal-body">
            <p class="mb-0">
              ¿Seguro que deseas eliminar a <strong>{{ duenoAEliminar?.nombre }}</strong
              >?
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-vet me-2" (click)="cancelarEliminar()">
              <i class="bi bi-x-circle"></i> Cancelar
            </button>
            <button type="button" class="btn btn-vet-danger" (click)="eliminarDueno()">
              <i class="bi bi-trash"></i> Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Gestionar Mascotas -->
  <div *ngIf="mostrarModalMascotas">
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content vet-modal">
          <div class="modal-header" style="background: #e8f5e9">
            <h5 class="modal-title d-flex align-items-center">
              <i class="bi bi-list-ul me-2" style="color: #6c63ff"></i>
              Mascotas de {{ duenoMascotas?.nombre }}
            </h5>
            <button type="button" class="btn-close" (click)="cerrarModalMascotas()"></button>
          </div>
          <div class="modal-body">
            <!-- Aquí irá la lista y gestión de mascotas -->
            <div *ngIf="cargandoMascotas" class="d-flex justify-content-center my-3">
              <div class="spinner-border" style="color: #6c63ff; width: 2rem; height: 2rem">
                <span class="visually-hidden">Cargando...</span>
              </div>
            </div>
            <div *ngIf="!cargandoMascotas">
              <!-- Listado de mascotas -->
              <div *ngIf="mascotasDueno.length === 0" class="text-center text-muted mb-3">
                No hay mascotas asociadas a este dueño.
              </div>
              <ul class="list-group mb-3">
                <li
                  *ngFor="let mascota of mascotasDueno"
                  class="list-group-item d-flex justify-content-between align-items-center"
                >
                  <span>
                    <button
                      class="btn btn-sm btn-outline-primary me-2"
                      (click)="editarMascota(mascota)"
                    >
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button
                      class="btn btn-sm btn-outline-danger"
                      (click)="eliminarMascota(mascota)"
                    >
                      <i class="bi bi-trash"></i>
                    </button>
                  </span>
                </li>
              </ul>
              <button class="btn btn-pastel w-100" (click)="abrirFormularioMascota()">
                <i class="bi bi-plus-circle"></i> Agregar Mascota
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Agregar/Editar Mascota -->
  <div *ngIf="mostrarFormularioMascota">
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content vet-modal">
          <div class="modal-header" style="background: #e8f5e9">
            <h5 class="modal-title d-flex align-items-center">
              <i class="bi bi-paw me-2" style="color: #6c63ff"></i>
              {{ mascotaActual ? 'Editar Mascota' : 'Agregar Mascota' }}
            </h5>
            <button
              type="button"
              class="btn-close"
              (click)="mostrarFormularioMascota = false"
            ></button>
          </div>
          <div class="modal-body">
            <form [formGroup]="mascotaForm" (ngSubmit)="guardarMascota()">
              <div class="mb-3">
                <label class="form-label"><i class="bi bi-paw me-1"></i> Nombre</label>
                <input type="text" class="form-control vet-input" formControlName="nombre" />
                <div
                  *ngIf="mascotaForm.get('nombre')?.invalid && mascotaForm.get('nombre')?.touched"
                  class="text-danger small"
                >
                  <span *ngIf="mascotaForm.get('nombre')?.errors?.['required']"
                    >El nombre es obligatorio.</span
                  >
                  <span *ngIf="mascotaForm.get('nombre')?.errors?.['minlength']"
                    >Mínimo 2 caracteres.</span
                  >
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label"><i class="bi bi-egg me-1"></i> Raza</label>
                <select class="form-control vet-input" formControlName="razaId">
                  <option value="">Selecciona raza</option>
                  <option *ngFor="let raza of razas" [value]="raza.id">{{ raza.nombre }}</option>
                </select>
                <div
                  *ngIf="mascotaForm.get('razaId')?.invalid && mascotaForm.get('razaId')?.touched"
                  class="text-danger small"
                >
                  <span *ngIf="mascotaForm.get('razaId')?.errors?.['required']"
                    >La raza es obligatoria.</span
                  >
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label"><i class="bi bi-gender-ambiguous me-1"></i> Sexo</label>
                <select class="form-control vet-input" formControlName="sexo">
                  <option value="">Selecciona sexo</option>
                  <option value="Macho">Macho</option>
                  <option value="Hembra">Hembra</option>
                </select>
                <div
                  *ngIf="mascotaForm.get('sexo')?.invalid && mascotaForm.get('sexo')?.touched"
                  class="text-danger small"
                >
                  <span *ngIf="mascotaForm.get('sexo')?.errors?.['required']"
                    >El sexo es obligatorio.</span
                  >
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label"
                  ><i class="bi bi-calendar me-1"></i> Fecha de nacimiento</label
                >
                <input
                  type="date"
                  class="form-control vet-input"
                  formControlName="fechaNacimiento"
                />
              </div>
              <div class="mb-3">
                <label class="form-label"><i class="bi bi-palette me-1"></i> Color</label>
                <input type="text" class="form-control vet-input" formControlName="color" />
              </div>
              <div class="mb-3">
                <label class="form-label"
                  ><i class="bi bi-chat-left-text me-1"></i> Observaciones</label
                >
                <textarea
                  class="form-control vet-input"
                  formControlName="observaciones"
                  rows="2"
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label"
                  ><i class="bi bi-journal-medical me-1"></i> Historial Médico</label
                >
                <textarea
                  class="form-control vet-input"
                  formControlName="historialesMedicos"
                  rows="2"
                  placeholder="Historial médico (JSON o resumen)"
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label"><i class="bi bi-calendar-check me-1"></i> Citas</label>
                <textarea
                  class="form-control vet-input"
                  formControlName="citas"
                  rows="2"
                  placeholder="Citas (JSON o resumen)"
                ></textarea>
              </div>
              <div class="d-flex justify-content-end">
                <button
                  type="button"
                  class="btn btn-vet me-2"
                  (click)="mostrarFormularioMascota = false"
                >
                  <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button
                  type="submit"
                  class="btn btn-vet"
                  [disabled]="mascotaForm.invalid || cargandoMascotaForm"
                >
                  <i class="bi bi-check-circle"></i>
                  {{ mascotaActual ? 'Modificar Mascota' : 'Agregar Mascota' }}
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
