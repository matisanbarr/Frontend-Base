<app-alert-global-local></app-alert-global-local>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Gestor de Dueños</h2>
    <button class="btn btn-primary" (click)="abrirFormulario()">Nuevo Dueño</button>
  </div>

  <div class="input-group mb-3">
    <input
      type="text"
      class="form-control"
      placeholder="Buscar por nombre"
      [(ngModel)]="busqueda"
    />
    <button class="btn btn-outline-secondary" (click)="buscar()">Buscar</button>
  </div>

  <div *ngIf="cargandoLista" class="d-flex justify-content-center align-items-center my-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>
  <table class="table table-hover" *ngIf="!cargandoLista">
    <thead class="table-light">
      <tr>
        <th>Nombre</th>
        <th>Teléfono</th>
        <th>Email</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let dueno of duenos">
        <td>{{ dueno.nombre }}</td>
        <td>{{ dueno.telefono }}</td>
        <td>{{ dueno.email }}</td>
        <td>
          <button class="btn btn-sm btn-info me-2" (click)="abrirFormulario(dueno)">Editar</button>
          <button class="btn btn-sm btn-danger" (click)="confirmarEliminar(dueno)">Eliminar</button>
        </td>
      </tr>
      <tr *ngIf="duenos.length === 0">
        <td colspan="4" class="text-center">No hay dueños registrados.</td>
      </tr>
    </tbody>
  </table>

  <!-- Paginación Bootstrap -->
  <nav *ngIf="totalDuenos > pageSize">
    <ul class="pagination justify-content-center">
      <li class="page-item" [class.disabled]="paginaActual === 1">
        <button class="page-link" (click)="cambiarPagina(paginaActual - 1)">&laquo;</button>
      </li>
      <li class="page-item" *ngFor="let p of paginas" [class.active]="paginaActual === p">
        <button class="page-link" (click)="cambiarPagina(p)">{{ p }}</button>
      </li>
      <li class="page-item" [class.disabled]="paginaActual === paginas.length">
        <button class="page-link" (click)="cambiarPagina(paginaActual + 1)">&raquo;</button>
      </li>
    </ul>
  </nav>

  <!-- Modal Formulario Crear/Editar -->
  <div *ngIf="mostrarFormulario" class="modal-backdrop fade show"></div>
  <div *ngIf="mostrarFormulario" class="modal d-block" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ editando ? 'Editar Dueño' : 'Nuevo Dueño' }}</h5>
          <button type="button" class="btn-close" (click)="cerrarFormulario()"></button>
        </div>
        <div class="modal-body">
          <form [formGroup]="duenoForm" (ngSubmit)="guardarDueno()">
            <div class="mb-3">
              <label class="form-label">Nombre</label>
              <input
                type="text"
                class="form-control"
                formControlName="nombre"
                (blur)="duenoForm.get('nombre')?.markAsTouched()"
              />
              <div
                *ngIf="duenoForm.get('nombre')?.invalid && duenoForm.get('nombre')?.touched"
                class="text-danger small"
              >
                <span *ngIf="duenoForm.get('nombre')?.errors?.['required']"
                  >El nombre es obligatorio.</span
                >
                <span *ngIf="duenoForm.get('nombre')?.errors?.['minlength']"
                  >Mínimo 3 caracteres.</span
                >
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Teléfono</label>
              <input
                type="text"
                class="form-control"
                formControlName="telefono"
                (blur)="duenoForm.get('telefono')?.markAsTouched()"
              />
              <div
                *ngIf="duenoForm.get('telefono')?.invalid && duenoForm.get('telefono')?.touched"
                class="text-danger small"
              >
                <span *ngIf="duenoForm.get('telefono')?.errors?.['required']"
                  >El teléfono es obligatorio.</span
                >
                <span *ngIf="duenoForm.get('telefono')?.errors?.['pattern']"
                  >Debe ser numérico y mínimo 8 dígitos.</span
                >
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Dirección</label>
              <input
                type="text"
                class="form-control"
                formControlName="direccion"
                (blur)="duenoForm.get('direccion')?.markAsTouched()"
              />
              <div
                *ngIf="duenoForm.get('direccion')?.invalid && duenoForm.get('direccion')?.touched"
                class="text-danger small"
              >
                <span *ngIf="duenoForm.get('direccion')?.errors?.['required']"
                  >La dirección es obligatoria.</span
                >
                <span *ngIf="duenoForm.get('direccion')?.errors?.['minlength']"
                  >Mínimo 5 caracteres.</span
                >
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input
                type="email"
                class="form-control"
                formControlName="email"
                (blur)="duenoForm.get('email')?.markAsTouched()"
              />
              <div
                *ngIf="duenoForm.get('email')?.invalid && duenoForm.get('email')?.touched"
                class="text-danger small"
              >
                <span *ngIf="duenoForm.get('email')?.errors?.['email']"
                  >Formato de email inválido.</span
                >
              </div>
            </div>
            <div class="d-flex justify-content-end">
              <button type="button" class="btn btn-secondary me-2" (click)="cerrarFormulario()">
                Cancelar
              </button>
              <button type="submit" class="btn btn-success" [disabled]="duenoForm.invalid">
                {{ editando ? 'Modificar Dueño' : 'Crear Dueño' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Confirmación Eliminar -->
  <div *ngIf="duenoAEliminar" class="modal-backdrop fade show"></div>
  <div *ngIf="duenoAEliminar" class="modal d-block" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar Eliminación</h5>
          <button type="button" class="btn-close" (click)="cancelarEliminar()"></button>
        </div>
        <div class="modal-body">
          <p>
            ¿Seguro que deseas eliminar a <strong>{{ duenoAEliminar?.nombre }}</strong
            >?
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="cancelarEliminar()">
            Cancelar
          </button>
          <button type="button" class="btn btn-danger" (click)="eliminarDueno()">Eliminar</button>
        </div>
      </div>
    </div>
  </div>
</div>
