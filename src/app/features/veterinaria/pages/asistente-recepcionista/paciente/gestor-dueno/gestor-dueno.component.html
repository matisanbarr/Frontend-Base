<app-alert-global></app-alert-global>
<div class="mb-3">
  <button class="btn btn-vet" (click)="volver(0)">
    <i class="bi bi-arrow-left"></i> Nuevo Dueño
  </button>
</div>
<div
  class="container py-4"
  style="
    background: #f6fff6;
    border-radius: 18px;
    box-shadow: 0 2px 12px #d0f5d0;
    position: relative;
  "
>
  <div class="vet-bg-icon">
    <i class="bi bi-paw" style="font-size: 5rem; color: #b2e2b2; opacity: 0.15"></i>
  </div>
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold d-flex align-items-center" style="color: #4caf50; letter-spacing: 1px">
      <i class="bi bi-paw me-2" style="font-size: 2rem; color: #81c784"></i>
      Gestor de Dueños de Mascotas
    </h2>
    <button class="btn btn-vet" (click)="abrirFormulario()">
      <i class="bi bi-person-plus"></i> Nuevo Dueño
    </button>
  </div>
  <div class="vet-search-flex mb-4">
    <input
      type="text"
      class="form-control vet-input"
      placeholder="Buscar dueño o mascota"
      [(ngModel)]="busqueda"
    />
    <button class="btn btn-vet vet-search-btn" (click)="buscar()">
      <i class="bi bi-search"></i> Buscar
    </button>
  </div>
  <div *ngIf="cargandoLista" class="d-flex justify-content-center align-items-center my-4">
    <div class="spinner-border" style="color: #4caf50; width: 3rem; height: 3rem">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>
  <div class="vet-table-responsive" *ngIf="!cargandoLista">
    <table class="table table-hover vet-table">
      <thead style="background: #e8f5e9">
        <tr>
          <th style="color: #388e3c"><i class="bi bi-person"></i> Nombre</th>
          <th style="color: #388e3c"><i class="bi bi-telephone"></i> Teléfono</th>
          <th style="color: #388e3c"><i class="bi bi-envelope"></i> Email</th>
          <th style="color: #388e3c"><i class="bi bi-paw"></i> Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let dueno of duenos">
          <td>{{ dueno.nombre }}</td>
          <td>{{ dueno.telefono }}</td>
          <td>{{ dueno.email }}</td>
          <td>
            <button class="btn btn-sm btn-vet me-2" (click)="abrirFormulario(dueno)">
              <i class="bi bi-pencil"></i> Editar
            </button>
            <button class="btn btn-sm btn-vet-danger" (click)="confirmarEliminar(dueno)">
              <i class="bi bi-trash"></i> Eliminar
            </button>
          </td>
        </tr>
        <tr *ngIf="duenos.length === 0">
          <td colspan="4" class="text-center" style="color: #a3a3a3">
            No hay dueños ni mascotas registrados.
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <nav *ngIf="totalDuenos > pageSize">
    <ul class="pagination justify-content-center vet-pagination">
      <li class="page-item" [class.disabled]="paginaActual === 1">
        <button class="page-link vet-page-link" (click)="cambiarPagina(paginaActual - 1)">
          &laquo;
        </button>
      </li>
      <li class="page-item" *ngFor="let p of paginas" [class.active]="paginaActual === p">
        <button class="page-link vet-page-link" (click)="cambiarPagina(p)">{{ p }}</button>
      </li>
      <li class="page-item" [class.disabled]="paginaActual === paginas.length">
        <button class="page-link vet-page-link" (click)="cambiarPagina(paginaActual + 1)">
          &raquo;
        </button>
      </li>
    </ul>
  </nav>

  <!-- Modal Formulario Crear/Editar -->
  <div *ngIf="mostrarFormulario" class="modal-backdrop fade show"></div>
  <div *ngIf="mostrarFormulario" class="modal d-block" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content vet-modal">
        <div class="modal-header" style="background: #e8f5e9">
          <h5 class="modal-title d-flex align-items-center">
            <i class="bi bi-paw me-2" style="color: #81c784"></i>
            {{ editando ? 'Editar Dueño' : 'Nuevo Dueño' }}
          </h5>
          <button type="button" class="btn-close" (click)="cerrarFormulario()"></button>
        </div>
        <div class="modal-body">
          <form [formGroup]="duenoForm" (ngSubmit)="guardarDueno()">
            <div class="mb-3">
              <label class="form-label"><i class="bi bi-person me-1"></i> Nombre</label>
              <input
                type="text"
                class="form-control vet-input"
                formControlName="nombre"
                (blur)="duenoForm.get('nombre')?.markAsTouched()"
              />
              <div
                *ngIf="duenoForm.get('nombre')?.invalid && duenoForm.get('nombre')?.touched"
                class="text-danger small"
              >
                <span *ngIf="duenoForm.get('nombre')?.errors?.['required']"
                  >El nombre es obligatorio.</span
                >
                <span *ngIf="duenoForm.get('nombre')?.errors?.['minlength']"
                  >Mínimo 3 caracteres.</span
                >
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label"><i class="bi bi-telephone me-1"></i> Teléfono</label>
              <input
                type="text"
                class="form-control vet-input"
                formControlName="telefono"
                (blur)="duenoForm.get('telefono')?.markAsTouched()"
              />
              <div
                *ngIf="duenoForm.get('telefono')?.invalid && duenoForm.get('telefono')?.touched"
                class="text-danger small"
              >
                <span *ngIf="duenoForm.get('telefono')?.errors?.['required']"
                  >El teléfono es obligatorio.</span
                >
                <span *ngIf="duenoForm.get('telefono')?.errors?.['pattern']"
                  >Debe ser numérico y mínimo 8 dígitos.</span
                >
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label"><i class="bi bi-house me-1"></i> Dirección</label>
              <input
                type="text"
                class="form-control vet-input"
                formControlName="direccion"
                (blur)="duenoForm.get('direccion')?.markAsTouched()"
              />
              <div
                *ngIf="duenoForm.get('direccion')?.invalid && duenoForm.get('direccion')?.touched"
                class="text-danger small"
              >
                <span *ngIf="duenoForm.get('direccion')?.errors?.['required']"
                  >La dirección es obligatoria.</span
                >
                <span *ngIf="duenoForm.get('direccion')?.errors?.['minlength']"
                  >Mínimo 5 caracteres.</span
                >
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label"><i class="bi bi-envelope me-1"></i> Email</label>
              <input
                type="email"
                class="form-control vet-input"
                formControlName="email"
                (blur)="duenoForm.get('email')?.markAsTouched()"
              />
              <div
                *ngIf="duenoForm.get('email')?.invalid && duenoForm.get('email')?.touched"
                class="text-danger small"
              >
                <span *ngIf="duenoForm.get('email')?.errors?.['email']"
                  >Formato de email inválido.</span
                >
              </div>
            </div>
            <div class="d-flex justify-content-end">
              <button type="button" class="btn btn-vet me-2" (click)="cerrarFormulario()">
                <i class="bi bi-x-circle"></i> Cancelar
              </button>
              <button type="submit" class="btn btn-vet" [disabled]="duenoForm.invalid">
                <i class="bi bi-check-circle"></i>
                {{ editando ? 'Modificar Dueño' : 'Crear Dueño' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Confirmación Eliminar -->
  <div *ngIf="duenoAEliminar" class="modal-backdrop fade show"></div>
  <div *ngIf="duenoAEliminar" class="modal d-block" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content vet-modal">
        <div class="modal-header" style="background: #f7a3a3">
          <h5 class="modal-title d-flex align-items-center">
            <i class="bi bi-exclamation-triangle me-2" style="color: #ff6363"></i>
            Confirmar Eliminación
          </h5>
          <button type="button" class="btn-close" (click)="cancelarEliminar()"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">
            ¿Seguro que deseas eliminar a <strong>{{ duenoAEliminar?.nombre }}</strong
            >?
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-vet me-2" (click)="cancelarEliminar()">
            <i class="bi bi-x-circle"></i> Cancelar
          </button>
          <button type="button" class="btn btn-vet-danger" (click)="eliminarDueno()">
            <i class="bi bi-trash"></i> Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
