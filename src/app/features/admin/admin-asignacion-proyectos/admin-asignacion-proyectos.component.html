<!-- Modal de confirmación para eliminar asignación -->
<!-- Modal nativo para eliminar asignación de proyecto -->
<div
  class="modal fade show"
  tabindex="-1"
  [ngStyle]="{ display: showConfirmModal ? 'block' : 'none', background: 'rgba(0,0,0,0.5)' }"
  *ngIf="showConfirmModal"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Eliminar asignación</h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Cerrar"
          (click)="cerrarModal()"
        ></button>
      </div>
      <div class="modal-body">
        <ng-container *ngIf="proyectosAEliminar.length > 1; else unProyecto">
          <div class="mb-2">
            Selecciona el proyecto a eliminar de <b>{{ empresaNombreAEliminar }}</b
            >:
          </div>
          <ul class="list-group mb-2">
            <li *ngFor="let proyecto of proyectosAEliminar" class="list-group-item">
              <label class="w-100">
                <input
                  type="radio"
                  name="proyectoEliminar"
                  [value]="proyecto.id"
                  (change)="seleccionarProyectoAEliminar(proyecto.id!)"
                  [checked]="asignacionAEliminarProyectoId === proyecto.id"
                  class="form-check-input me-2"
                />
                {{ proyecto.nombre }}
              </label>
            </li>
          </ul>
          <div class="text-danger small" *ngIf="!asignacionAEliminarProyectoId">
            Debes seleccionar un proyecto para eliminar.
          </div>
        </ng-container>
        <ng-template #unProyecto>
          <p>
            ¿Seguro que deseas eliminar el proyecto de <b>{{ empresaNombreAEliminar }}</b
            >?
          </p>
        </ng-template>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cancelar</button>
        <button
          type="button"
          class="btn btn-danger"
          [disabled]="!asignacionAEliminarProyectoId"
          (click)="confirmarEliminacion()"
        >
          Eliminar
        </button>
      </div>
    </div>
  </div>
</div>

<div class="container py-4">
  <app-toast-alerts [alerts]="alertService.getAlerts()"></app-toast-alerts>
  <div class="row">
    <!-- Listado de asignaciones -->
    <div class="col-12 col-md-6 mb-4">
      <div class="card">
        <div class="card-header card-header-info">
          <h5 class="mb-0">Empresas y sus proyectos asignados</h5>
          <div class="mt-2">
            <input
              type="text"
              class="form-control"
              placeholder="Buscar empresa..."
              [(ngModel)]="filtroBusqueda"
              (input)="buscarAsignaciones()"
            />
          </div>
        </div>
        <div class="card-body p-0">
          <ng-container *ngIf="loading; else listaAsignaciones">
            <div class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
            </div>
          </ng-container>
          <ng-template #listaAsignaciones>
            <div style="max-height: 400px; overflow-y: auto">
              <app-admin-list
                [items]="asignaciones"
                [nombreFn]="asignacionEmpresaFn"
                [rolesFn]="asignacionProyectosFn"
                [loading]="loading"
                [emptyText]="'No hay asignaciones registradas.'"
                (remove)="eliminarAsignacion($event)"
                (edit)="editarAsignacion($event)"
              ></app-admin-list>
            </div>
            <div *ngIf="totalPaginas > 1" class="d-flex align-items-center p-2">
              <button
                *ngIf="paginaActual > 1"
                class="btn btn-outline-primary me-2"
                (click)="cambiarPagina(paginaActual - 1)"
              >
                Anterior
              </button>
              <span class="flex-grow-1 text-center"
                >Página {{ paginaActual }} de {{ totalPaginas }}</span
              >
              <button
                *ngIf="paginaActual < totalPaginas"
                class="btn btn-outline-primary ms-2"
                (click)="cambiarPagina(paginaActual + 1)"
              >
                Siguiente
              </button>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
    <!-- Formulario de asignación -->
    <div class="col-12 col-md-6">
      <div class="card">
        <app-admin-form-header
          icon="bi bi-diagram-3"
          [titulo]="'Asignación de Proyectos'"
          [modoEdicion]="modoEdicion"
          [labelCrear]="'Asignar Proyectos'"
          [labelEditar]="'Modificar asignación'"
          [mostrarEstado]="false"
        ></app-admin-form-header>
        <div class="card-body">
          <form [formGroup]="asignacionForm" (ngSubmit)="guardarAsignacion()">
            <div class="mb-3">
              <label for="empresa" class="form-label">Empresa</label>
              <select class="form-select" id="empresa" formControlName="empresaId">
                <option value="" disabled selected>Seleccione una empresa</option>
                <option *ngFor="let empresa of empresas" [value]="empresa.id">
                  {{ empresa.nombre }}
                </option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Proyectos</label>
              <div
                class="proyectos-cards-list border rounded p-2"
                style="max-height: 200px; overflow-y: auto"
              >
                <div *ngFor="let proyecto of proyectos" class="proyecto-card-wrapper">
                  <label
                    class="proyecto-card"
                    [class.selected]="proyectosSeleccionados.includes(proyecto.id || '')"
                  >
                    <input
                      type="checkbox"
                      class="form-check-input visually-hidden"
                      [value]="proyecto.id || ''"
                      (change)="onProyectoCheck($event, proyecto.id || '')"
                      [checked]="proyectosSeleccionados.includes(proyecto.id || '')"
                      tabindex="-1"
                    />
                    <span class="proyecto-card-content">{{ proyecto.nombre }}</span>
                  </label>
                </div>
              </div>
            </div>
            <app-form-buttons
              [modoEdicion]="modoEdicion"
              [formInvalid]="asignacionForm.invalid || proyectosSeleccionados.length === 0"
              [loading]="loading"
              [crearLabel]="'Asignar Proyectos'"
              [modificarLabel]="'Modificar asignación'"
              [hayCambios]="true"
              [limpiarVisible]="modoEdicion"
              (limpiar)="limpiarFormulario()"
              (submit)="guardarAsignacion()"
            ></app-form-buttons>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
